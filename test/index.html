<!DOCTYPE html>
<html lang="en" data-theme="dark">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Schematic Renderer Pro</title>

		<script type="module" src="./main.ts"></script>
		<!-- Alpine.js -->
		<script
			defer
			src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
		></script>

		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>

		<!-- DaisyUI -->
		<link
			href="https://cdn.jsdelivr.net/npm/daisyui@3.1.6/dist/full.css"
			rel="stylesheet"
			type="text/css"
		/>

		<!-- Heroicons -->
		<script src="https://unpkg.com/heroicons@1.0.6/dist/outline.js"></script>

		<!-- Custom Styles -->
		<style>
			/* Custom Styles */
			.canvas-container {
				position: relative;
				width: 100%;
				max-width: 2400px;
				height: 80vh;
				margin: auto;
				background-color: #1f2937; /* Tailwind's gray-800 */
				border-radius: 0.5rem;
				box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
			}
			#canvas {
				width: 100%;
				height: 100%;
				display: block;
				border-radius: 0.5rem;
			}
			.overlay {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				pointer-events: none;
			}
			.overlay > * {
				pointer-events: auto;
			}
			/* Menu Bar */
			.menu-bar {
				background-color: rgba(
					31,
					41,
					55,
					0.9
				); /* Tailwind's gray-800 with opacity */
				backdrop-filter: blur(10px);
			}
			/* Floating Toolbar */
			.floating-toolbar {
				background-color: rgba(31, 41, 55, 0.9);
				backdrop-filter: blur(10px);
				padding: 0.5rem;
				border-radius: 0.5rem;
			}
			/* Status Cards */
			.status-card {
				background-color: rgba(31, 41, 55, 0.9);
				backdrop-filter: blur(10px);
				padding: 0.5rem 1rem;
				border-radius: 0.5rem;
			}
			/* Buttons */
			.menu-btn,
			.toolbar-btn {
				@apply btn btn-sm btn-ghost text-white;
			}
			.menu-btn:hover,
			.toolbar-btn:hover {
				@apply bg-gray-700;
			}
			/* Dropdown */
			.dropdown-content {
				backdrop-filter: blur(5px);
			}
			/* Sidebar */
			.sidebar {
				background-color: rgba(31, 41, 55, 0.9);
				backdrop-filter: blur(10px);
				width: 250px;
				max-width: 100%;
				height: 100%;
				position: absolute;
				top: 0;
				right: 0;
				overflow-y: auto;
				z-index: 10;
				padding: 1rem;
			}
			.sidebar-header {
				font-size: 1.25rem;
				font-weight: bold;
				margin-bottom: 1rem;
				color: white;
			}
			.schematic-item {
				display: flex;
				align-items: center;
				justify-content: space-between;
				background-color: rgba(55, 65, 81, 0.9); /* Tailwind's gray-700 */
				padding: 0.5rem;
				border-radius: 0.25rem;
				margin-bottom: 0.5rem;
				color: white;
			}
			.schematic-item:hover {
				background-color: rgba(75, 85, 99, 0.9); /* Tailwind's gray-600 */
			}
			.schematic-name {
				flex-grow: 1;
				margin-right: 0.5rem;
			}
		</style>
	</head>
	<body
		class="bg-gray-900 flex flex-col items-center justify-center min-h-screen p-4"
		x-data="rendererUI()"
		x-init="init()"
	>
		<div class="canvas-container relative">
			<canvas id="canvas"></canvas>

			<div class="overlay flex flex-col h-full">
				<!-- Menu Bar -->
				<div
					class="menu-bar flex items-center justify-between p-2 h-12 text-sm"
				>
					<div class="flex items-center space-x-4">
						<!-- View Dropdown -->
						<div class="dropdown dropdown-hover">
							<label tabindex="0" class="menu-btn flex items-center space-x-1">
								<svg class="w-5 h-5" fill="none" stroke="currentColor">
									<use href="#heroicon-o-eye"></use>
								</svg>
								<span>View</span>
							</label>
							<ul
								tabindex="0"
								class="dropdown-content menu p-2 shadow bg-gray-800 rounded-box w-52"
							>
								<li><a @click="toggleGrid">Toggle Grid</a></li>
								<li><a @click="toggleAxes">Toggle Axes</a></li>
							</ul>
						</div>
						<!-- Camera Dropdown -->
						<div class="dropdown dropdown-hover">
							<label tabindex="0" class="menu-btn flex items-center space-x-1">
								<svg class="w-5 h-5" fill="none" stroke="currentColor">
									<use href="#heroicon-o-camera"></use>
								</svg>
								<span>Camera</span>
							</label>
							<ul
								tabindex="0"
								class="dropdown-content menu p-2 shadow bg-gray-800 rounded-box w-52"
							>
								<li><a @click="resetCamera">Reset Camera</a></li>
								<li><a @click="switchToPerspective">Perspective View</a></li>
								<li><a @click="switchToOrthographic">Orthographic View</a></li>
							</ul>
						</div>
					</div>
					<!-- Right Side Buttons -->
					<div class="flex items-center space-x-2">
						<button class="menu-btn" @click="toggleFullScreen">
							<svg class="w-5 h-5" fill="none" stroke="currentColor">
								<use href="#heroicon-o-arrows-expand"></use>
							</svg>
						</button>
						<button class="menu-btn" @click="takeScreenshot">
							<svg class="w-5 h-5" fill="none" stroke="currentColor">
								<use href="#heroicon-o-photograph"></use>
							</svg>
						</button>
					</div>
				</div>

				<!-- Status Cards -->
				<div class="absolute bottom-4 left-4 flex space-x-4">
					<div class="status-card flex flex-col text-white text-sm">
						<span class="font-semibold">Coordinates</span>
						<span id="coordinates">
							X: <span x-text="cameraPosition.x">0.00</span>, Y:
							<span x-text="cameraPosition.y">0.00</span>, Z:
							<span x-text="cameraPosition.z">0.00</span>
						</span>
					</div>
					<!-- Add more status cards if needed -->
				</div>

				<!-- Schematics Sidebar -->
				<div class="sidebar" x-show="showSidebar">
					<div class="sidebar-header flex justify-between items-center">
						<span>Schematics</span>
						<button
							class="btn btn-sm btn-primary"
							@click="addSchematic"
							title="Add Schematic"
						>
							<svg class="w-5 h-5" fill="none" stroke="currentColor">
								<use href="#heroicon-o-plus"></use>
							</svg>
						</button>
					</div>
					<div class="schematic-list">
						<template x-for="schematic in schematics" :key="schematic.id">
							<div class="schematic-item">
								<span class="schematic-name" x-text="schematic.name"></span>
								<button
									class="btn btn-xs"
									:class="schematic.visible ? 'btn-success' : 'btn-warning'"
									@click="toggleSchematicVisibility(schematic)"
									:title="schematic.visible ? 'Hide' : 'Show'"
								>
									<svg class="w-4 h-4" fill="none" stroke="currentColor">
										<use
											:href="schematic.visible
                        ? '#heroicon-o-eye'
                        : '#heroicon-o-eye-off'"
										></use>
									</svg>
								</button>
							</div>
						</template>
					</div>
				</div>

				<!-- Toggle Sidebar Button -->
				<button
					class="absolute top-16 right-4 btn btn-circle btn-sm btn-ghost"
					@click="showSidebar = !showSidebar"
					title="Toggle Schematics Panel"
				>
					<svg class="w-5 h-5" fill="none" stroke="currentColor">
						<use
							:href="showSidebar ? '#heroicon-o-chevron-right' : '#heroicon-o-chevron-left'"
						></use>
					</svg>
				</button>
			</div>
		</div>

		<!-- Script -->
		<script>
			function rendererUI() {
				return {
					renderer: null,
					cameraPosition: { x: 0.0, y: 0.0, z: 0.0 },
					schematics: [],
					showSidebar: true,
					init() {
						// Wait for the renderer to be initialized
						document
							.getElementById("canvas")
							.addEventListener("rendererInitialized", () => {
								console.log("Renderer initialized");
								this.renderer =
									document.getElementById("canvas").schematicRenderer;

								// Ensure the renderer is initialized
								if (!this.renderer) {
									console.warn(
										"Renderer not initialized attempting to retrieve"
									);
									return;
								}

								// Listen for camera position changes
								const updateCameraPosition = (event) => {
									if (event.property === "position") {
										if (Array.isArray(event.value)) {
											this.cameraPosition = {
												x: event.value[0].toFixed(2),
												y: event.value[1].toFixed(2),
												z: event.value[2].toFixed(2),
											};
										} else {
											this.cameraPosition = {
												x: event.value.x.toFixed(2),
												y: event.value.y.toFixed(2),
												z: event.value.z.toFixed(2),
											};
										}
									}
								};

								this.renderer.cameraManager.on(
									"propertyChanged",
									updateCameraPosition
								);

								// Initialize with current camera position
								const initialPosition = this.renderer.cameraManager.position;
								this.cameraPosition = {
									x: initialPosition.x.toFixed(2),
									y: initialPosition.y.toFixed(2),
									z: initialPosition.z.toFixed(2),
								};

								// Initialize schematics list
								this.updateSchematicsList();

								// Listen for changes in the schematics
								this.renderer.schematicManager.eventEmitter.on(
									"schematicAdded",
									() => {
										this.updateSchematicsList();
									}
								);

								this.renderer.schematicManager.eventEmitter.on(
									"schematicRemoved",
									() => {
										this.updateSchematicsList();
									}
								);

								// Update schematic visibility when changed externally
								this.renderer.schematicManager.eventEmitter.on(
									"schematicPropertyChanged",
									({ schematic, property, value }) => {
										if (property === "visible") {
											const schematicItem = this.schematics.find(
												(s) => s.id === schematic.id
											);
											if (schematicItem) {
												schematicItem.visible = value;
											}
										}
									}
								);
							});
					},
					updateSchematicsList() {
						if (!this.renderer) {
							console.warn("Renderer not initialized");
							return;
						}
						const schematicObjects = Array.from(
							this.renderer.schematicManager.schematics.values()
						);
						this.schematics = schematicObjects.map((schematic) => ({
							id: schematic.id,
							name: schematic.name,
							visible: schematic.visible,
						}));
					},
					toggleSchematicVisibility(schematic) {
						const rendererSchematic =
							this.renderer.schematicManager.schematics.get(schematic.id);
						if (rendererSchematic) {
							rendererSchematic.visible = !rendererSchematic.visible;
							schematic.visible = rendererSchematic.visible;
						}
					},
					addSchematic() {
						if (!this.renderer) {
							console.warn("Renderer not initialized");
							return;
						}

						// Create an input element dynamically
						const input = document.createElement("input");
						input.type = "file";
						input.accept = ".schematic,.schem, .litematic";

						input.onchange = async (event) => {
							const file = event.target.files[0];
							if (file) {
								try {
									await this.renderer.schematicManager.loadSchematicFromFile(
										file
									);
									// Update the schematics list
									this.updateSchematicsList();
								} catch (error) {
									console.error("Failed to load schematic:", error);
								}
							}
						};

						// Trigger the file dialog
						input.click();
					},

					toggleGrid() {
						if (!this.renderer) {
							console.warn("Renderer not initialized");
							return;
						}
						this.renderer.sceneManager.showGrid =
							!this.renderer.sceneManager.showGrid;
					},
					toggleAxes() {
						if (!this.renderer) {
							console.warn("Renderer not initialized");
							return;
						}
						this.renderer.sceneManager.showAxes =
							!this.renderer.sceneManager.showAxes;
					},
					resetCamera() {
						this.renderer.cameraManager.focusOnSchematics();
					},
					switchToPerspective() {
						if (!this.renderer) {
							console.warn("Renderer not initialized");
							return;
						}
						this.renderer.cameraManager.activeCamera.changeType("perspective");
					},
					switchToOrthographic() {
						if (!this.renderer) {
							console.warn("Renderer not initialized");
							return;
						}
						this.renderer.cameraManager.activeCamera.changeType("orthographic");
					},
					toggleFullScreen() {
						const elem = document.documentElement;
						if (!document.fullscreenElement) {
							elem.requestFullscreen().catch((err) => {
								alert(
									`Error attempting to enable full-screen mode: ${err.message} (${err.name})`
								);
							});
						} else {
							document.exitFullscreen();
						}
					},
					takeScreenshot() {
						if (!this.renderer) {
							console.warn("Renderer not initialized");
							return;
						}
						// Example screenshot functionality
						const dataURL =
							this.renderer.renderManager.renderer.domElement.toDataURL(
								"image/png"
							);
						const link = document.createElement("a");
						link.href = dataURL;
						link.download = "screenshot.png";
						link.click();
					},
				};
			}
		</script>
	</body>
</html>
